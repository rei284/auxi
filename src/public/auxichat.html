<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Auxi</title>

  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@4.0.0/tex-chtml.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/atom-one-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>

  <style>
    :root {
      --bg: #282c34;
      --surface1: #353b45;
      --surface2: #3e4451;
      --border: #181a1f;
      --text: #abb2bf;
      --subtext: #5c6370;
      --blue: #61afef;
      --green: #98c379;
      --red: #e06c75;
      --yellow: #e5c07b;
      --purple: #c678dd;
      --cyan: #56b6c2;
      --white: #ffffff;
    }

    body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); display: flex; flex-direction: column; height: 100vh; }
    header { padding: 1rem 2rem; font-size: 1.6rem; font-weight: 600; background: var(--surface1); border-bottom: 1px solid var(--surface2); text-align: center; color: var(--blue); box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
    .chat-container { flex: 1; overflow-y: auto; padding: 2rem; display: flex; flex-direction: column; gap: 1rem; background: var(--bg); }

    .message {
      max-width: 70%;
      padding: 1rem 1.2rem;
      border-radius: 14px;
      line-height: 1.5;
      word-wrap: break-word;
      animation: fadeInUp 0.3s ease forwards;
      background: var(--surface2);
      box-shadow: 2px 2px 6px rgba(0,0,0,0.4);
      transition: transform 0.2s ease;
      color: var(--text);
      /* NO scrollbars */
    }

    .message:hover { transform: translateY(-2px); }
    .user { align-self: flex-end; background: var(--green); color: var(--bg); }
    .bot { align-self: flex-start; background: var(--surface1); color: var(--text); border: 1px solid var(--surface2); }

    .message pre, .message code { max-width: 100%; }

    @keyframes fadeInUp { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

    .input-area { display: flex; flex-direction: column; gap: 0.5rem; padding: 1rem; background: var(--surface1); border-top: 1px solid var(--surface2); }
    .input-row { display: flex; gap: 0.5rem; }
    .input-area input { flex: 1; padding: 0.8rem 1rem; border-radius: 10px; border: none; outline: none; font-size: 1rem; background: var(--surface2); color: var(--text); transition: background 0.2s ease; }
    .input-area input:focus { background: var(--surface1); }
    .input-area button { padding: 0.8rem 1.2rem; border: none; border-radius: 10px; background: var(--blue); color: var(--bg); font-weight: 600; cursor: pointer; transition: background 0.2s ease; }
    .input-area button:hover { background: var(--cyan); }

    .quick-buttons { display: flex; flex-wrap: wrap; gap: 0.5rem; padding: 0.5rem 1rem; background: var(--bg); border-top: 1px solid var(--surface2); }
    .quick-buttons button { padding: 0.5rem 0.9rem; border: none; border-radius: 8px; background: var(--purple); color: var(--bg); font-size: 0.9rem; cursor: pointer; transition: background 0.2s ease, transform 0.1s ease; }
    .quick-buttons button:hover { background: var(--blue); transform: translateY(-1px); }
  </style>
</head>
<body>
  <header>Auxi</header>

  <div class="chat-container" id="chat"></div>

  <div class="quick-buttons">
    <button onclick="sendMessage('Define VSEPR theory')">Define VSEPR theory</button>
    <button onclick="sendMessage('Write a python program to check if a string is a palindrome')">Write a python program to check if a string is a palindrome</button>
    <button onclick="sendMessage('Summarize all of Macbeth')">Summarize all of Macbeth</button>
    <button onclick="sendMessage('What part of the brain is responsible for maintaining balance')">What part of the brain is responsible for maintaining balance</button>
  </div>

  <div class="input-area">
    <div class="input-row">
      <input type="text" id="userInput" placeholder="Type your message..." />
      <button onclick="handleInput()">Send</button>
    </div>
  </div>

<script>
const chatContainer = document.getElementById("chat");
const userInput = document.getElementById("userInput");

// Render Markdown + Math
function renderMarkdown(text, element) {
  const mathBlocks = [];

  // Protect display math
  text = text.replace(/(\$\$[\s\S]+?\$\$|\\\[[\s\S]+?\\\])/g, m => {
    const placeholder = `@@MATH${mathBlocks.length}@@`;
    mathBlocks.push(m);
    return placeholder;
  });

  // Protect inline math
  text = text.replace(/(\$[^\$]+\$|\\\([^\)]+\\\))/g, m => {
    const placeholder = `@@MATH${mathBlocks.length}@@`;
    mathBlocks.push(m);
    return placeholder;
  });

  text = marked.parse(text, { breaks: true });

  mathBlocks.forEach((block, i) => {
    text = text.replace(`@@MATH${i}@@`, block);
  });

  element.innerHTML = text;

  element.querySelectorAll('pre code').forEach(block => hljs.highlightBlock(block));
  if (window.MathJax) MathJax.typeset([element]);
}

// Add message to chat
function addMessage(text, sender, render = true) {
  const msg = document.createElement("div");
  msg.classList.add("message", sender);
  if (render) renderMarkdown(text, msg);
  else msg.textContent = text;
  chatContainer.appendChild(msg);
  chatContainer.scrollTop = chatContainer.scrollHeight;
  return msg;
}

// Type bot message progressively
async function typeMessage(element, text, chunkSize = 6, delay = 15) {
  let typed = "";
  for (let i = 0; i < text.length; i += chunkSize) {
    typed += text.slice(i, i + chunkSize);
    renderMarkdown(typed, element);
    chatContainer.scrollTop = chatContainer.scrollHeight;
    await new Promise(r => setTimeout(r, delay));
  }
}

async function sendMessage(question) {
  addMessage(question, "user", true); // user messages fully rendered

  try {
    const res = await fetch("http://localhost:3000/api/chat/ask", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ question }),
    });
    const answer = await res.text();

    const botMsg = addMessage("", "bot"); // empty initially
    await typeMessage(botMsg, answer);
  } catch (err) {
    addMessage("Error: Could not connect to the server.", "bot");
  }
}

function handleInput() {
  const text = userInput.value.trim();
  if (text) {
    sendMessage(text);
    userInput.value = "";
  }
}

userInput.addEventListener("keydown", e => {
  if (e.key === "Enter") handleInput();
});
</script>
</body>
</html>
