<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AuxiQuiz - AI StudyBuddy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js" crossorigin="anonymous"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1A202C;
            color: #E2E8F0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            position: relative; 
        }

        #radial-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0; 
            background-image: radial-gradient(ellipse at 50% 40%, 
                rgb(31, 48, 69) 30%, 
                rgb(20, 23, 29) 70% 
            );
        }
        
        #header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 20;
            background-color: rgba(26, 32, 44, 0.8);
            backdrop-filter: blur(5px); 
            border-bottom: 1px solid #2D3748;
            box-shadow: 0 4px 30px rgba(99, 102, 241, 0.1); 
        }

        #main-content {
            padding-top: 6rem;
            padding-bottom: 3rem;
            max-width: 800px; 
            width: 100%;
            margin-left: auto;
            margin-right: auto;
            min-width: 300px; 
            z-index: 10;
        }

        .nav-link {
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            color: #E2E8F0;
            transition: color 0.2s, background-color 0.2s;
        }
        .nav-link:hover {
            color: #ffffff;
            background-color: #2D3748;
        }
    
        .nav-link.active {
            color: #6366F1;
            font-weight: 600;
        }

        .form-input {
            background-color: #2D3748;
            border: 1px solid #4A5568;
            color: #E2E8F0;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus {
            outline: none;
            border-color: #6366F1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.4);
        }
        
        .quiz-option {
            border: 1px solid #4A5568;
            transition: all 0.2s;
        }
        .quiz-option:hover {
            background-color: #2D3748;
            border-color: #6366F1;
        }

        input:checked + .quiz-option {
             border-color: #6366F1;
             background-color: #3B4467;
        }

        .correct-answer {
            background-color: #14532D !important;
            border-color: #34D399 !important;
            color: #E2E8F0;
        }
        .incorrect-answer {
            background-color: #7F1D1D !important;
            border-color: #FCA5A5 !important;
            color: #E2E8F0;
        }

        .btn-primary {
            background-color: #6366F1;
            transition: background-color 0.2s, transform 0.1s;
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.2);
        }
        .btn-primary:hover {
            background-color: #7B79E7;
            transform: translateY(-2px);
        }
         .btn-primary:disabled {
            background-color: #4A5568;
            cursor: not-allowed;
            transform: none;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }

    </style>
</head>
<body class="p-0 m-0">

    <div id="radial-background"></div>

    <header class="bg-background-dark/95 backdrop-blur-sm sticky top-0 z-50 shadow-xl shadow-black/20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-5 flex items-center justify-between">
            <a href="./homepage.html" class="flex items-center space-x-2 text-heading-color hover:opacity-90 transition-opacity">
                <div class="w-8 h-8 flex items-center justify-center">
                    <img src="https://api.iconify.design/lucide-book.svg?color=%23f8fafc" alt="Auxi logo - minimal book" class="w-7 h-7" />
                </div>
                <span class="text-2xl font-bold font-heading tracking-tight">Auxi</span>
            </a>
            
            <nav class="flex space-x-2 sm:space-x-4 text-sm font-medium">
                <a href="./homepage.html" class="nav-link">Home</a>
                <a href="./auxichat.html" class="nav-link hidden sm:block">Auxi Chat</a>
                <a href="./quiz.html" class="nav-link hidden sm:block active">Quiz</a>
                <a href="./shop.html" class="nav-link hidden sm:block">Shop</a>
                <a href="./about-us.html" class="nav-link hidden sm:block">About Us</a>
                <a href="./frontpage.html" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-3 rounded-lg shadow-md transition duration-300 flex items-center gap-1.5 whitespace-nowrap">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-log-out">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                        <polyline points="16 17 21 12 16 7"/>
                        <line x1="21" x2="9" y1="12" y2="12"/>
                    </svg>
                    Log Out
                </a>
            </nav> 
        </div>
    </header>

    <div id="main-content" class="flex-grow p-4">
        
        <div id="quiz-setup-screen" class="w-full">
            <div class="text-center mb-10">
                <h2 class="text-4xl md:text-5xl font-extrabold text-[#E2E8F0] mb-2 tracking-tight">Create Your Quiz</h2>
                <p class="text-lg text-gray-400 max-w-md mx-auto font-light">Tell us what you want to learn, and we'll generate a quiz just for you.</p>
            </div>
            
            <div class="bg-[#2D3748]/50 border border-[#4A5568] p-8 rounded-2xl shadow-2xl max-w-xl mx-auto space-y-6">
                <div>
                    <label for="topic" class="block text-sm font-medium text-gray-300 mb-2">Topic</label>
                    <input type="text" id="topic" class="form-input w-full p-3 rounded-lg text-lg" placeholder="e.g., Photosynthesis, World War II">
                </div>
                <div>
                    <label for="grade" class="block text-sm font-medium text-gray-300 mb-2">Grade / Level</label>
                    <input type="text" id="grade" class="form-input w-full p-3 rounded-lg text-lg" placeholder="e.g., High School, University Freshman">
                </div>
                <div>
                    <label for="board" class="block text-sm font-medium text-gray-300 mb-2">Board / Major</label>
                    <input type="text" id="board" class="form-input w-full p-3 rounded-lg text-lg" placeholder="e.g., AP Biology, History Major">
                </div>
                <div>
                    <label for="num-questions" class="block text-sm font-medium text-gray-300 mb-2">Number of Questions</label>
                    <input type="number" id="num-questions" class="form-input w-full p-3 rounded-lg text-lg" value="5" min="3" max="15">
                </div>
                <button id="generate-quiz-btn" class="btn-primary w-full text-white font-bold py-3 px-4 rounded-lg text-lg flex items-center justify-center">
                    <span>Generate Quiz</span>
                </button>
            </div>
        </div>

        <div id="quiz-display-screen" class="hidden w-full">
        </div>

        <div id="quiz-results-screen" class="hidden w-full text-center p-8 bg-[#2D3748]/50 border border-[#4A5568] rounded-2xl">
        </div>
    </div>

    <script>
        const apiKey = "AIzaSyA2RZfj5OvgEg74eINzLu7zMRh26ylIvrE"; 
        const modelName = "gemini-2.5-flash-preview-05-20";
        const ttsModelName = "gemini-2.5-flash-preview-tts";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;

        const setupScreen = document.getElementById('quiz-setup-screen');
        const displayScreen = document.getElementById('quiz-display-screen');
        const resultsScreen = document.getElementById('quiz-results-screen');
        const generateBtn = document.getElementById('generate-quiz-btn');
        const topicInput = document.getElementById('topic');
        const gradeInput = document.getElementById('grade');
        const boardInput = document.getElementById('board');
        const numQuestionsInput = document.getElementById('num-questions');

        let quizData = [];
        let userAnswers = [];

        generateBtn.addEventListener('click', generateQuiz);

        async function generateQuiz() {
            const topic = topicInput.value.trim();
            const grade = gradeInput.value.trim();
            const board = boardInput.value.trim();
            const numQuestions = numQuestionsInput.value.trim();

            if (!topic || !grade || !board || !numQuestions) {
                showModal("Validation Error", "Please fill out all fields to generate a quiz.");
                return;
            }

            if (!apiKey) {
                console.error("API Key is missing or not provided.");
            }

            setLoadingState(true);

            const systemPrompt = `You are a helpful AI that generates educational multiple-choice quizzes. 
            Your goal is to create a quiz with ${numQuestions} questions.
            You must respond with ONLY a valid JSON object. Do not include any other text or markdown formatting.
            The JSON object should have a single key: "questions".
            The value of "questions" should be an array of ${numQuestions} question objects.
            Each question object must have three keys:
            1. "question_text": A string containing the question. IMPORTANT: Use LaTeX formatting (e.g., "$$ E=mc^2 $$") for all mathematical or scientific notation.
            2. "options": An array of 4 strings representing the possible answers. IMPORTANT: Use LaTeX formatting (e.g., "$ \text{H}_2\text{O} $") for all mathematical or scientific notation.
            3. "correct_answer_index": An integer from 0 to 3 indicating the index of the correct answer in the "options" array.`;

            const userPrompt = `Generate a quiz with ${numQuestions} questions on the topic of "${topic}" for a "${grade}" student studying the "${board}" curriculum.`;

            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            let response;
            const maxRetries = 3;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (response.status !== 429 && response.ok) break;
                    if (i < maxRetries - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                } catch (error) {
                    console.error("Fetch attempt failed:", error);
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }


            try {
                if (!response.ok) {
                    throw new Error(`API error: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (!text) {
                     throw new Error("Received an empty response from the AI. The prompt might be too restrictive or the model failed to generate content.");
                }
                
                const cleanText = text.trim().replace(/^```json\s*/, '').replace(/\s*```$/, '');
                const parsedJson = JSON.parse(cleanText);
                
                if (!Array.isArray(parsedJson.questions) || parsedJson.questions.length === 0) {
                    throw new Error("AI response did not contain a valid list of questions.");
                }

                quizData = parsedJson.questions;
                displayQuiz();

            } catch (error) {
                console.error("Failed to generate or parse quiz:", error);
                showModal("Generation Failed", `An error occurred while creating the quiz: ${error.message}. Please try again.`);
            } finally {
                setLoadingState(false);
            }
        }

        function displayQuiz() {
            setupScreen.classList.add('hidden');
            resultsScreen.classList.add('hidden');
            displayScreen.innerHTML = '';
            displayScreen.classList.remove('hidden');

            const quizHeader = document.createElement('h2');
            quizHeader.className = "text-3xl font-extrabold text-[#E2E8F0] mb-8 text-center";
            quizHeader.textContent = `Quiz on ${topicInput.value}`;
            displayScreen.appendChild(quizHeader);

            const form = document.createElement('form');
            form.id = 'quiz-form';
            form.className = 'space-y-8';

            quizData.forEach((q, index) => {
                const questionBlock = document.createElement('div');
                questionBlock.id = `question-block-${index}`; 
                questionBlock.className = 'bg-[#2D3748]/50 border border-[#4A5568] p-6 rounded-xl';
                
                const questionText = document.createElement('p');
                questionText.className = 'text-lg font-medium text-gray-100 mb-4';
                questionText.textContent = `${index + 1}. ${q.question_text}`;
                questionBlock.appendChild(questionText);

                const optionsGrid = document.createElement('div');
                optionsGrid.className = 'grid grid-cols-1 sm:grid-cols-2 gap-3';
                
                q.options.forEach((option, optionIndex) => {
                    const optionWrapper = document.createElement('div');
                    optionWrapper.className = 'relative';

                    const radio = document.createElement('input');
                    radio.type = 'radio';
                    radio.id = `q${index}_option${optionIndex}`;
                    radio.name = `question-${index}`;
                    radio.value = optionIndex;
                    radio.className = 'hidden';

                    const label = document.createElement('label');
                    label.htmlFor = `q${index}_option${optionIndex}`;
                    label.textContent = option;
                    label.className = 'quiz-option block w-full text-left p-4 rounded-lg cursor-pointer font-light';
                    
                    optionWrapper.appendChild(radio);
                    optionWrapper.appendChild(label);
                    optionsGrid.appendChild(optionWrapper);
                });

                questionBlock.appendChild(optionsGrid);
                form.appendChild(questionBlock);
            });
            
            const submitButton = document.createElement('button');
            submitButton.type = 'submit';
            submitButton.textContent = 'Submit Answers';
            submitButton.className = 'btn-primary w-full text-white font-bold py-3 px-4 rounded-lg text-lg';
            
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                submitQuiz();
            });

            form.appendChild(submitButton);
            displayScreen.appendChild(form);
            
            renderMathInElement(displayScreen, {
                delimiters: [
                    { left: "$$", right: "$$", display: true },
                    { left: "$", right: "$", display: false }
                ],
                throwOnError: false
            });
        }

        function submitQuiz() {
            let score = 0;
            userAnswers = [];
            const form = document.getElementById('quiz-form');

            quizData.forEach((q, index) => {
                const selectedOption = form.querySelector(`input[name="question-${index}"]:checked`);
                
                const questionBlock = document.getElementById(`question-block-${index}`);
                
                const optionLabels = questionBlock.querySelectorAll('label');

                const inputs = questionBlock.querySelectorAll('input');
                inputs.forEach(input => input.disabled = true);

                if (selectedOption) {
                    const answerIndex = parseInt(selectedOption.value);
                    userAnswers[index] = answerIndex;

                    if (answerIndex === q.correct_answer_index) {
                        score++;
                        optionLabels[answerIndex].classList.add('correct-answer');
                    } else {
                        optionLabels[answerIndex].classList.add('incorrect-answer');
                        optionLabels[q.correct_answer_index].classList.add('correct-answer');
                    }
                } else {
                    userAnswers[index] = -1;
                    optionLabels[q.correct_answer_index].classList.add('correct-answer');
                }
            });

            showResults(score);
        }

        function showResults(score) {
            const submitButton = displayScreen.querySelector('.btn-primary');
            if (submitButton) submitButton.remove(); 
            
            const totalQuestions = quizData.length;
            const points = score * 10;
            
            let message = '';
            if (score === totalQuestions) {
                message = "🎉 Perfect Score! Excellent Work! 🎉";
            } else if (score >= totalQuestions / 2) {
                message = "Keep up the great effort! You're almost there.";
            } else {
                message = "Good start! Reviewing the answers below will help you next time.";
            }

            resultsScreen.innerHTML = `
                <h2 class="text-4xl font-extrabold text-[#E2E8F0] mb-2">Quiz Complete!</h2>
                <p class="text-2xl text-[#6366F1] font-semibold mb-4">${message}</p>
                <p class="text-3xl text-white font-extrabold mb-4">${score} / ${totalQuestions}</p>
                <p class="text-xl text-gray-300 mb-8">You've earned <span class="font-bold text-yellow-400">${points} points!</span></p>
                <button id="new-quiz-btn" class="btn-primary text-white font-bold py-3 px-6 rounded-lg text-lg">
                    Start a New Quiz
                </button>
            `;
            resultsScreen.classList.remove('hidden');
            document.getElementById('new-quiz-btn').addEventListener('click', () => {
                topicInput.value = '';
                gradeInput.value = '';
                boardInput.value = '';
                numQuestionsInput.value = '5';
                setupScreen.classList.remove('hidden');
                displayScreen.classList.add('hidden');
                resultsScreen.classList.add('hidden');
                setupScreen.scrollIntoView({ behavior: 'smooth' });
            });

            resultsScreen.scrollIntoView({ behavior: 'smooth' });
        }
        
        function setLoadingState(isLoading) {
            if (isLoading) {
                setupScreen.querySelector('div:last-child').classList.add('opacity-50', 'pointer-events-none');
                generateBtn.disabled = true;
                generateBtn.innerHTML = `
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                    </svg>
                    <span>Generating...</span>
                `;
            } else {
                setupScreen.querySelector('div:last-child').classList.remove('opacity-50', 'pointer-events-none');
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<span>Generate Quiz</span>';
            }
        }

        function showModal(title, message) {
            let modal = document.getElementById('custom-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'custom-modal';
                modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black/70 p-4 hidden';
                modal.innerHTML = `
                    <div class="bg-gray-800 p-6 rounded-xl shadow-2xl max-w-sm w-full border border-gray-700">
                        <h3 id="modal-title" class="text-xl font-bold text-white mb-3"></h3>
                        <p id="modal-message" class="text-gray-300 mb-6"></p>
                        <button id="modal-close-btn" class="btn-primary w-full py-2 rounded-lg font-semibold">
                            OK
                        </button>
                    </div>
                `;
                document.body.appendChild(modal);
                document.getElementById('modal-close-btn').addEventListener('click', () => {
                    modal.classList.add('hidden');
                });
            }
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            modal.classList.remove('hidden');
        }
    </script>
</body>
</html>
